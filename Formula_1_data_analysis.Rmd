---
title: "Formula 1 data analysis"
author: "Andreas Svenningsen"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warnings = F)
```

# Packages
```{r}
library(tidyverse)
library(lubridate)
```


# Importing data

```{r}
df <- read_csv("Testing notebooks/SPAIN_Race_laps.csv", show_col_types = F)
head(laps)
```

# EDA
```{r}

cat("Columns:", colnames(df), "\n")

driver.names <- unique(df$Driver)
cat("Drivers:", driver.names, "\n")

driver.nr <- unique(df$DriverNumber)
cat("Driver nr:", driver.nr, "\n")

```

### Compare drivers laptimes

```{r}

laps <- df %>% drop_na(LapTime)
laptimes <- c()
for (i in 1:length(laps$LapTime)) {
  laptime <- gsub("0 days 00:","",laps$LapTime[i])
  laptimes <- c(laptimes, as.numeric(ms(laptime)))
}

laps$LapTime <- laptimes


compare_drivers_laptime <- function(laps, drivers, plot = F) {
  drivers_laps <- data.frame()
  for (i in 1:length(drivers)) {
    driver_laps <- subset(laps, Driver == drivers[i]) %>% subset(., LapTime < 85)
    drivers_laps <- rbind(driver_laps, drivers_laps)
  }
  if (plot) {
    ggplot(drivers_laps, aes(LapNumber, LapTime, col= Driver)) + geom_line()
  }
  else {
    return(drivers_laps)
  }
}

comparison_data <- compare_drivers_laptime(laps, driver.names)
p <- ggplot(comparison_data, aes(LapNumber, LapTime, col= Driver)) + geom_line()
ggplotly(p) %>% rangeslider()


```



```{r}
library(ggplot2)
library(plotly)
library(shiny)

# Create a vector of all unique drivers in the dataset
all_drivers <- unique(comparison_data$Driver)

# Define the UI
ui <- fluidPage(
  selectInput("driverSelect", "Select Drivers:", choices = all_drivers, 
              selected = c("MAG", "VER"), multiple = TRUE),
  plotlyOutput("plot")
)

# Define the server function
server <- function(input, output, session) {
  # Create a reactive variable to store the selected drivers
  selected_drivers <- reactive({
    input$driverSelect
  })

  # Create the ggplot object with reactive data
  p <- reactive({
    filtered_data <- subset(comparison_data, Driver %in% selected_drivers())
    ggplot(filtered_data, aes(LapNumber, LapTime, col = Driver)) + geom_line()
  })

  # Create the plotly object
  p_plotly <- reactive({
    ggplotly(p()) %>% rangeslider()
  })

  # Render the plotly object
  output$plot <- renderPlotly({
    p_plotly()
  })
}

# Run the Shiny app
shinyApp(ui, server)
```






